<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <title>
      packages/openvpn – Freetz
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="/search" />
        <link rel="help" href="../TracGuide.html" />
        <link rel="alternate" href="openvpn%3Fformat=txt" type="text/x-trac-wiki" title="Reiner Text" />
        <link rel="up" href="../packages.html" title="Übergeordnete Wiki-Seite anzeigen" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../chrome/common/css/wiki.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/phrases.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes-300.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes-narrow-toc.css" type="text/css" /><link rel="stylesheet" href="../../wikicss.css" type="text/css" /><link rel="stylesheet" href="../../chrome/tags/css/tractags.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikinegotiator/css/langmenu-ctxnav.css" type="text/css" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Freetz durchsuchen" />
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/jquery.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/babel.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/messages/de.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/trac.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/search.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/folding.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $("#content").find(".wikianchor").each(function() {
          $(this).addAnchor(babel.format(_("Link to #%(id)s"), {id: $(this).attr('id')}));
        });
        $(".foldable").enableFolding(true, true);
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="/wiki"><img src="../../chrome/common/freetz_motd.png" alt="Freetz" /></a>
      </div>
      <form id="search" action="https://www.google.com/search" method="get" onsubmit="; this.elements.namedItem('q').value = this.elements.namedItem('oq').value + ' site:freetz.github.io'">
        <div>
          <label for="proj-search">Suche:</label>
          <input type="text" id="proj-search" name="oq" size="18" value="" />
          <input type="hidden" name="q" value="" />
          <input type="submit" value="Suche" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><li class="last"><a href="../Impressum.html">Impressum</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="/wiki">Wiki</a></li><li class="last"><a href="/screenshots">Bildschirmfotos</a></li>
    </ul>
  </div>
    <div id="langmenu"><ul><li class="first"><span title="Select a language of wiki content">Language:</span></li><li class=" active"><a class="" href="openvpn.html" title="displaying language (default)">German</a></li><li class=" last"><a class=" notexist" href="/wiki/packages/openvpn.en" title="(not available)">English</a></li></ul></div><p /><div id="main">
      <div id="pagepath" class="noprint">
  <a class="pathentry first" title="Zeige WikiStart an" href="/wiki">Wiki:</a><a class="pathentry" href="../packages.html" title="Zeige packages an">packages</a><span class="pathentry sep">/</span><a class="pathentry" href="openvpn.html" title="Zeige packages/openvpn an">openvpn</a>
</div>
    <div id="content" class="wiki">
      <div class="wikipage searchable">

          <div id="wikipage" class="trac-content"><p>
</p><div class="wiki-toc"><h4>Inhaltsverzeichnis</h4><ol><li><a href="openvpn.html#Version">Version</a></li><li><a href="openvpn.html#HäufigeFragenHowto">Häufige Fragen / Howto</a></li><li><a href="openvpn.html#Konfigurationsanleitung">Konfigurationsanleitung</a><ol><li><a href="openvpn.html#Portweiterleitung">Portweiterleitung</a></li><li><a href="openvpn.html#StaticKey">Static Key</a></li><li><a href="openvpn.html#Zertifikate">Zertifikate</a></li></ol></li><li><a href="openvpn.html#Routingvs.Bridging">Routing vs. Bridging</a></li><li><a href="openvpn.html#CRL">CRL</a></li><li><a href="openvpn.html#Fehlersuche:EinpaarTipswennesnichtgleichsoklappt">Fehlersuche: Ein paar Tips wenn es nicht gleich so klappt</a></li><li><a href="openvpn.html#Verschlüsselung:WelcherCipher">Verschlüsselung: Welcher "Cipher" ?</a></li><li><a href="openvpn.html#DNSRedirectallclientstraffic">DNS &amp; Redirect all clients' traffic</a></li><li><a href="openvpn.html#Diskussion">Diskussion</a></li><li><a href="openvpn.html#NeuesimpleGUIGUI2">Neue, simple GUI (GUI2)</a><ol><li><a href="openvpn.html#WeitereKonfigsanlegen">Weitere Konfigs anlegen</a></li></ol></li></ol></div><p>
</p>
<h1 id="OpenVPNfreetzPackage">OpenVPN freetz Package</h1>
<p>
OpenVPN ist ein Programm zur Herstellung eines Virtuellen Privaten Netzwerkes (VPN) über eine verschlüsselte TLS-Verbindung.
</p>
<h2 id="Version">Version</h2>
<p>
In der aktuellen Version von Freetz ist OpenVPN 2.3.2 enthalten (aktuell kann auch noch die alte Version 2.2.1 gewählt werden). Es kann im menuconfig wahlweise mit und ohne LZO2 Komprimierung ausgewählt werden.
</p>
<h2 id="HäufigeFragenHowto">Häufige Fragen / Howto</h2>
<p>
Die Dokumentation auf der OpenVPN Webseite ist sehr gut und ausführlich. Dort findet man wohl auf die meisten Fragen die passende Antwort.
</p>
<p>
<a class="ext-link" href="http://openvpn.net/faq.html"><span class="icon">​</span>http://openvpn.net/faq.html</a> oder <a class="ext-link" href="http://openvpn.net/howto.html"><span class="icon">​</span>http://openvpn.net/howto.html</a>
</p>
<p>
Viele hilfreiche Informationen zu OpenVPN findet man auch <a class="ext-link" href="http://wiki.ip-phone-forum.de/gateways:avm:howtos:mods:openvpn"><span class="icon">​</span>hier im ippf-Wiki</a>.
</p>
<h2 id="Konfigurationsanleitung">Konfigurationsanleitung</h2>
<p>
Dies ist eine (sicher nicht ganz vollständige) Anleitung zur Konfiguration des OpenVPN Pakets. Sie soll aufzeigen, wie man eine OpenVPN Konfiguration mit der zugehörigen GUI erstellt. *Was* ein VPN ist und welche Parameter man grundsätzlich braucht, kann hier *nicht* gefunden werden.
</p>
<h3 id="Portweiterleitung">Portweiterleitung</h3>
<p>
Soll (was wohl meistens der Fall ist), die Verbindung auf die Box über das Internet aufgebaut werden, so muss dafür eine "Portweiterleitung" eingerichet werden, damit die Box die VPN-Pakete annimmt. Standardmäßig nutzt OpenVPN den IP-Port 1194 mit UDP oder TCP, und die Pakete dafür müssen von der Box angenommen werden. Die naheliegende Idee, dieses in der Fritzbox GUI einzurichten wird von AVM unterbunden, indem keine Weiterleitungen "auf die Box selbst" erlaubt werden. Prinzipiell gibt es drei Möglichkeiten, das zu "umgehen":
</p>
<ol><li>Indem die Box eine zusätzliche IP-Adresse bekommt, von der die GUI "nichts weiss" und damit die Einrichtung über die GUI vornehmen. Dafür kann das Paket <a class="wiki" href="virtualip.html">Virtual IP</a> genutzt werden und dann in der GUI eine Weiterleitung auf diese IP eingerichtet werden. Mittlerweile gibt es einige User, die damit Probleme gemeldet haben (vermutlich wegen der "Startreihenfolge" der Pakete). Als Alternative dazu bietet es sich an, in der <a class="ext-link" href="http://wiki.ip-phone-forum.de/gateways:avm:howtos:mods:shell_scripte#erzeugen_der_dateien_aus_der_debug.cfg"><span class="icon">​</span>debug.cfg</a> eine weitere IP anzulegen (zum Beispiel mittels des Eintrags "ifconfig lan:1 192.168.178.253" in dieser Datei).
</li><li>Man verwendet das Freetz-Paket <a class="wiki" href="avm-firewall.html">avm-firewall</a>. Hierdurch kann man einfach im Freetz-GUI eine Portweiterleitung auf die IP-Adresse 0.0.0.0 eintragen. Anschließend ist der Port vom Internet aus offen (Achtung: UDP als Protokoll auswählen!).
</li><li>Oder man editiert die Datei "/var/flash/ar7.cfg", wozu der Zugriff auf die Box mit Telnet/SSH nötig ist, was jedoch mit freetz kein Problem darstellt. Obwohl diese Methode etwas "risikoreicher" ist ( weil eine "falsch editierte Datei" den Start der Box verhindern kann) würde ich sie empfehlen.
</li></ol><p>
Ich würde vorschlagen, die Datei im RAM zu editieren und dann, wenn alles "zufriedenstellend" erfolgt ist, die Datei zurück zu kopieren. Zum "Kopieren" nutzt man hier das "Auslesen und Umleiten", da diese Datei keine normale Datei ist. Die Stelle, an der man ändern muß, findet man am einfachsten, indem man zuvor in der AVM-GUI unter Einstellungen &rarr; Erweitertet Einstellungen &rarr; Internet &rarr; Portfreigabe &rarr; Neue Portfreigabe eine aussagekräftige Portfreigabe erstellt, z.B. "MeineFreigabe". Diese kann in der im vi geöffneten /var/tmp/ar7.cfg gesucht werden mit /MeineFreigabe.
</p>
<pre class="wiki">  cat /var/flash/ar7.cfg &gt; /var/tmp/ar7.cfg
  vi /var/tmp/ar7.cfg

  # Mini-Anleitung zu vi:
  # i  Insert  - an dieser Stelle etwas eingeben
  # a  append  - nach dieser Stelle etwas eingeben
  # o          - Zeile nach der aktuellen Zeile einfügen
  # O          - Zeile vor der aktuellen Zeile einfügen
  # /&lt;Ausdruck&gt;- Suche vorwärts nach Ausdruck
  # A  Append  - am Ende der Zeile etwas eingeben
  # r  replace - den Buchstaben unter dem Cursor ersetzen
  # x  delete  - den Buchstaben unter dem Cursor löschen
  # &lt;Zahl&gt;     - den nächsten Befehl so oft ausführen (z.B. 10x -&gt; 10 Zeichen löschen)
  # dd         - Zeile Löschen
  # D          - Rest der Zeile ab aktuellem Zeichen löschen
  # &lt;ESC&gt;      - Editier- / Eingabe-Modus verlassen
  # :w  write  - Änderungen Speichern
  # :q  quit   - vi verlassen
  # :q!        - vi verlassen, auch wenn ungesicherte Änderungen waren
  #
  #
  # Hier nun im vi die Freigabe eintragen und die Datei mit ":wq" abgespeichert

  # Wenn alles richtig war, kann diese neue Datei zurückgeschrieben werden:
  cat /var/tmp/ar7.cfg &gt; /var/flash/ar7.cfg
</pre><blockquote>
<p>
Im Ergebnis muss zu den "forwardrules" eine der folgenden Art hinzugefügt werden, natürlich mit dem richtigen Protokoll (TCP/UDP) und der richtigen Port-Nummer. Zu beachten ist, dass die Zeilen mit "," abzuschließen sind, die letzte Zeile mit ";":
</p>
</blockquote>
<pre class="wiki">  ## falls es **nicht** die letzte Zeile ist so,
  ## wenn es **die letzte** ist, bitte ein ";" statt des ","
  "udp 0.0.0.0:1194 0.0.0.0:1194" ,
</pre><p>
Das Format dafür ist: &lt;Protokoll&gt; &lt;In IP&gt;:&lt;In IP-Port&gt;  &lt;Out IP &gt;:&lt;Out IP-Port&gt;  Hier ist das erste "0.0.0.0" jeweils alles eingehende das zweite "0.0.0.0" steht für "die Box selbst". Der "ausgehende" Port ist hier wie der eingehende der Standardport von OpenVPN: 1194.
</p>
<p>
Nach dem Editieren der ar7.cfg muss die Änderung übernommen werden, z.B. mittels <em>ar7cfgchanged</em> oder einem Reboot.
</p>
<p>
<strong>Relativ neu:</strong> Mittels <a class="ext-link" href="http://www.ip-phone-forum.de/showthread.php?t=159266"><span class="icon">​</span>dieses Patches</a> ist auch eine Freigabe über die "normale" Portfreigabe in der AVM-GUI auf die Box selbst mit 0.0.0.0 möglich.
</p>
<h3 id="StaticKey">Static Key</h3>
<p>
Die einfachste Variante ist der Betrieb mit statischem Schlüssel:
</p>
<ul><li>es kann sich immer ein Client gleichzeitig mit dem Server verbinden
</li><li>beide Seiten verwenden den selben statischen Schlüssel zur Authentifizierung
</li><li>beim ersten Start des Dienstes wird ein Schlüssel automatisch erzeugt
</li><li>Der Schlüssel kann unter "Einstellungen &rarr; Static Key" ausgelesen und eingestellt werden <br /> (eventuell vorher die <a class="ext-link" href="http://wiki.ip-phone-forum.de/software:ds-mod:faq#konfiguration_in_der_aktuellen_sicherheitsstufe_nicht_verfuegbar"><span class="icon">​</span>Sicherheitsstufe einstellen</a>)
</li><li>die IP-Zuweisung erfolgt manuell auf Client und Server
</li></ul><p>
Hier mal ein Beispiel mit folgenden Daten:
</p>
<pre class="wiki">  Server-IP 192.168.200.1
  Client-IP 192.168.200.2
  Netzwerk hinter Fritzbox 192.168.178.0/255.255.255.0
</pre><p>
In der GUI wäre der Server dann so zu konfigurieren:
</p>
<p>
<span class="thumbnail"><span class="aux" style="width: 537px;"><a style="border-width: 1px;" href="/screenshots/27?format=raw" title="OpenVPN Webinterface: static server "><img src="/screenshots/27?width=535&amp;format=raw&amp;height=719" alt="OpenVPN Webinterface: static server " /></a><span class="description" style="width: 537px;">OpenVPN Webinterface: static server</span></span></span>
</p>
<p>
Eine passende Windows-Client-Konfiguration dazu, die sich auf die Box verbinden kann:
</p>
<pre class="wiki">  remote meinserver.dyndns.org
  proto udp
  dev tun
  ifconfig 192.168.200.2 192.168.200.1
  route 192.168.178.0 255.255.255.0
  secret "D:\\Eigene Dateien\\OpenVPN\\fritzbox.key"
  tun-mtu 1500
  float
  mssfix
  nobind
  verb 3
  keepalive 10 120
</pre><h3 id="Zertifikate">Zertifikate</h3>
<p>
Wenn man mehrere gleichzeitige Verbindungen ermöglichen will, muss man mit Zertifikaten arbeiten.
</p>
<ul><li>es können sich mehrere Clients gleichzeitig mit dem Server verbinden
</li><li>Zertifikate müssen erstellt und auf Server und Client hinterlegt werden
</li><li>Die Zertifikate werden über "Einstellungen" eingetragen (Zuordnung siehe weiter unten)
</li><li>die IP-Zuweisung erfolgt dynamisch durch den Server
</li><li>einfache Konfiguration der Clients durch Push/Pull
</li></ul><p>
Wie man ganz einfach Zertifikate erstellen und auf die Box laden kann, erklären u.a. dieser <a class="ext-link" href="http://wiki.ip-phone-forum.de/gateways:avm:howtos:mods:openvpn#2._zertifikate_erstellen"><span class="icon">​</span>Wiki-Eintrag</a> sowie die offizielle OpenVPN Hilfe zum Thema  <a class="ext-link" href="http://openvpn.net/howto.html#pki"><span class="icon">​</span>Public Key Infrastructure</a>. Die Zertifikate werden auch mit Hilfe der GUI auf die Box geladen werden. Dafür öffnet man im Freetz das Menu Einstellungen und wählt den entsprechenden Eintrag aus (z.B. OpenVPN: Box Cert). Mit einem Editor öffnet man nun die entsprechende Datei (z.B. Server.crt) und kopiert den Inhalt in das Freetz Fenster. Mit Übernehmen überträgt nun die GUI das Zertifikat auf die Box. <br /> <strong><em>Hinweis:</em></strong> Bevor man unter "Einstellungen" Dinge eintragen kann, muss man ggf vorher die Sicherheitsstufe entsprechend ändern, das geht z.B. mit <br />
</p>
<blockquote>
<p>
<em>  echo 0 &gt; /var/tmp/flash/security &amp;&amp; modsave</em>
</p>
</blockquote>
<p>
Zuordnung der Schlüssel und Zertifikate auf der Box:
</p>
<table class="wiki">
<tr><td> GUI-Name </td><td> Datei-Name </td><td> Beispiel / Bemerkung
</td></tr><tr><td> Box Cert </td><td> &lt;Name&gt;.crt </td><td> server.crt od. client01.crt
</td></tr><tr><td> Private Key </td><td> &lt;Name&gt;.key </td><td> server.key oder client01.key
</td></tr><tr><td> CA Cert </td><td> ca.crt </td><td> Zertifikat der CA
</td></tr><tr><td> DH Param </td><td> dh&lt;Länge&gt;.pem </td><td> dh1024.pem od. dh2048.pem
</td></tr><tr><td> Static Key </td><td> wird generiert </td><td> muss auf Server und Client gleich sein
</td></tr><tr><td> CRL </td><td> leer lassen </td><td> Liste zurückgezogener Zertifikate
</td></tr></table>
<p>
In der folgenden Beispiel-Konfiguration soll der Server auf der Box mit mehreren Clients genutzt werden können und im TAP-Modus laufen. Die meiste Konfiguration der Clients (IP- und Netzwerkeinstellungen, Routing, usw.) erfolgt ebenfalls durch den Server. <br /> Der Server vergibt an die Clients IP-Adressen ab der 192.168.200.100 bis 192.168.200.150. Er übergibt dem Client auch eine Route zu seinem LAN, dem Netz 192.168.178.0. Für das "Abholen" dieser Parameter sorgt das <strong><em>pull</em></strong> in der Client-Konfiguration.
</p>
<p>
<span class="thumbnail"><span class="aux" style="width: 556px;"><a style="border-width: 1px;" href="/screenshots/28?format=raw" title="OpenVPN Webinterface: certificate server"><img src="/screenshots/28?width=554&amp;format=raw&amp;height=998" alt="OpenVPN Webinterface: certificate server" /></a><span class="description" style="width: 556px;">OpenVPN Webinterface: certificate server</span></span></span>
</p>
<p>
Ebenfalls wieder eine Client-Konfiguration dazu, die sich mit diesem Server verbinden könnte:
</p>
<pre class="wiki">  remote meinserver.dyndns.org
  proto udp
  dev tap
  tls-client
  ns-cert-type server
  ca "D:\\Eigene Dateien\\OpenVPN\\ca.crt"
  cert "D:\\Eigene Dateien\\OpenVPN\\client.crt"
  key "D:\\Eigene Dateien\\OpenVPN\\client.key"
  tls-auth "D:\\Eigene Dateien\\OpenVPN\\static.key" 1
  tun-mtu 1500
  mssfix
  nobind
  pull
  cipher AES-128-CBC
  verb 3
</pre><p>
Dass der Name des Servers (hinter <strong>"remote"</strong>) und die Pfade zu den Zertifikaten ggf. anzupassen sind, versteht sich hoffentlich von selbst <img src="../../chrome/wikiextras-icons-16/smiley-wink.png" style="vertical-align: text-bottom" alt=";-)" />. Man sieht, dass der Client keine eigene IP Konfiguration oder Routing Einträge hat, diese Parameter bekommt er mit dem <em>pull</em>  vom Server. Wichtig ist hierbei auch die <strong>"Schlüsselrichtung"</strong> bei der TLS-Authentifizierung. Da freetz hierfür augenscheinlich den Wert "0" nutzt, muss im Client entsprechend der Wert "1" gesetzt werden.
</p>
<h2 id="Routingvs.Bridging">Routing vs. Bridging</h2>
<p>
Für die meisten Anwendungsfälle ist Routing (TUN) die beste Wahl, doch in einigen Fällen kann es auch sinnvoll sein, das VPN Netzwerk mit einer Brücke (TAP) zu realisieren.  Eine ausführliche Beschreibung der Unterschiede findet man auf der <a class="ext-link" href="http://openvpn.net/faq.html#bridge2"><span class="icon">​</span>OpenVPN Webseite</a>
</p>
<p>
Hier ein paar Vorteile von Bridging:
</p>
<ul><li>Der Client befindet sich nach Aufbau der Verbindung im gleichen Netz wie der Server
</li><li>Broadcasts werden durch den VPN-Tunnel geleitet, das hat den Vorteil, dass z.B. NetBIOS Namen aufgelöst werden können (sinnvoll für PING, Netzwerkfreigaben etc)
</li><li>Bridging leitet alle Ethernet-Protokolle über den Tunnel (IPv4, IPv6, IPX, AppleTalk etc.)
</li></ul><p>
Hier ein paar Nachteile von Bridging:
</p>
<ul><li>weniger effizient als Routing (langsamer)
</li><li>alle Broadcasts gehen durch das Netz
</li></ul><p>
Um mit der Fritz Box ein echtes Bridging zu realisieren, ist es notwendig, den tap0-Adapter in die Liste der gebrückten Adapter der Fritz Box einzutragen. Dies geschieht wiederum in der ar7.cfg, die im oben beschriebenen Verfahren geändert werden muß. Unter dem Punkt "brinterfaces" &rarr; interfaces muß der tap0-Adapter ergänzt werden:
</p>
<p>
Also wieder:
</p>
<pre class="wiki">  cat /var/flash/ar7.cfg &gt; /var/tmp/ar7.cfg
  vi /var/tmp/ar7.cfg
</pre><p>
Dann suchen nach /brinterfaces und den Eintrag "tap0" vor dem Semikolon einfügen.
</p>
<pre class="wiki">  brinterfaces {
                name = "lan";
                dhcp = no;
                ipaddr = 192.168.178.1;
                netmask = 255.255.255.0;
                dstipaddr = 0.0.0.0;
                interfaces = "eth0", "usbrndis", "tiwlan0", "wdsup0",
                             "wdsdw0", "wdsdw1", "wdsdw2", "wdsdw3", "tap0";
                dhcpenabled = yes;
                dhcpstart = 192.168.178.20;
                dhcpend = 192.168.178.100;
</pre><p>
Zum Abschluß noch mal
</p>
<pre class="wiki">  cat /var/tmp/ar7.cfg &gt; /var/flash/ar7.cfg
  reboot
</pre><p>
Die Konfiguration in der OpenVPN-Gui könnte für den FritzBox Standard dann folgendermaßen aussehen:
</p>
<p>
<span class="thumbnail"><span class="aux" style="width: 544px;"><a style="border-width: 1px;" href="/screenshots/29?format=raw" title="OpenVPN Webinterface: bridged server"><img src="/screenshots/29?width=542&amp;format=raw&amp;height=596" alt="OpenVPN Webinterface: bridged server" /></a><span class="description" style="width: 544px;">OpenVPN Webinterface: bridged server</span></span></span>
</p>
<p>
Die Windows-Client-Konfiguration dazu sieht so aus:
</p>
<pre class="wiki">  client
  dev tap
  #udp/tcp je nachdem, was ausgewählt wurde
  proto tcp
  #Port entsprechend der Konfiguration
  remote meinserver.dyndns.org 443
  nobind
  persist-key
  persist-tun
  #hier die Zertifikate/Schlüssel, wie beim Erstellen benannt
  ca ca.crt
  cert client01.crt
  key client01.key
  # für TLS-Remote "ServerBox1" wie beim Erstellen benannt
  tls-remote ServerBox1
  tls-auth static.key 1
  auth SHA1
  cipher AES-256-CBC
  comp-lzo
  verb 3
</pre><h2 id="CRL">CRL</h2>
<p>
CRL steht für "certificate revocation list" und bietet eine Möglichkeit, ausgestellte Zertifikate zurückzuziehen und damit ungültig zu machen. Aktuell gibt es einen BUG in Freetz (<a href="/ticket/1578">/ticket/1578</a>) so dass eine CRL nur mit etwas Handarbeit über die Telnet Konsole bzw. Rudishell zum Laufen gebracht werden kann. Wer sich das manuelle Erstellen einer CRL nicht zutraut findet mit Kleopatra (Windows / <a class="ext-link" href="http://www.gpg4win.de/"><span class="icon">​</span>http://www.gpg4win.de/</a>) oder TinyCA (Linux / <a class="ext-link" href="http://tinyca.sm-zone.net/"><span class="icon">​</span>http://tinyca.sm-zone.net/</a>) GUI-basierte Zertifikatmanager, die das Erstellen einer CRL unterstützen.
</p>
<h2 id="Fehlersuche:EinpaarTipswennesnichtgleichsoklappt">Fehlersuche: Ein paar Tips wenn es nicht gleich so klappt</h2>
<p>
Meist versucht man gleich den schwierigsten Fall, über das Internet mit Zertifikaten und TLS-Authentifizierung zwei Netze zu verbinden und testet, indem man versucht eine Freigabe auf dem Fileserver im anderen Netz anzubinden <img src="../../chrome/wikiextras-icons-16/smiley-wink.png" style="vertical-align: text-bottom" alt=";-)" />.
</p>
<p>
Schön, wenn es sofort klappt, dafür gibt es "unendlich" viele Fehlermöglichkeiten falls nicht&hellip;
</p>
<p>
Daher der Apell, tastet euch langsam an das ganze heran!
</p>
<ul><li>Erster "Fehlerkandidat" ist der Zugang über das Internet, der über eine "virtuelle IP" oder in der Datei "/var/flash/ar7.cfg" freigeschaltet werden muss (siehe oben, ich bevorzuge persönlich die zweite Methode). Diesen Faktor kann man prüfen, indem man die Verbindung zunächst mal "intern" testet, also über die LAN-Schnittstelle. Klappt es so, aber nicht über das Internet, habt ihr den Fehler eingegrenzt.
</li><li>Wenn es was anderes ist, hilt nur noch der Vergleich der Konfigurationen Punkt für Punkt. Eigentlich gibt es nur zwei Arten von Parametern:<br />Solche, die identisch sein müssen und solche, die "spiegelverkehrt" auftreten müssen.
<ul><li>Die "identischen" sind z.B. Cipher, "comp-lzo", tls-auth, das benutzte Protokoll (UDP/TCP) und der Port,<br />
</li><li>"Spiegelbildlich" sind die IPs beim TUN, die Routing-Einträge, die Server- / Client-Parameter wie "tls-server/tls-client", push und pull.
</li></ul></li><li>Die Config auf der Box kann man am einfachsten in der <a class="wiki" href="rudi-shell.html">Rudi-Shell</a> ausgeben lasssen, indem man dort <br /> <em>cat /mod/etc/openvpn*.conf</em><br />ausführt. Diese Config kann man dann gut mit der Config der "Gegenseite" vergleichen.
</li><li>Erste Hilfe für mehr Infos, z.B. wenn die Ausgabe nur lautet <br /><em>Starting OpenVPN &hellip;failed. </em><br />In der <a class="wiki" href="rudi-shell.html">Rudi-Shell</a>  (wenn openvpn nicht mehr läuft) sollten so (spätestens nach zehn Sekunden) die Startmeldungen Hinweise auf den Fehler bringen.:
<pre class="wiki">  # die .../openvpn*.conf wird erst beim Starten des Dienstes erstellt und beim Stoppen gelöscht!
</pre><pre class="wiki">  cat /mod/etc/openvpn*.conf | grep -v daemon &gt; /var/tmp/ovpn.conf
  openvpn /var/tmp/ovpn.conf &amp;
  sleep 10
  killall openvpn
</pre></li><li>Ein typisches Fehlerbild (ich tippe mal auf mindestens 20% aller Probleme <img src="../../chrome/wikiextras-icons-16/smiley-wink.png" style="vertical-align: text-bottom" alt=";-)" />): Die Verbindung wird aufgebaut, aber der Client und Server können sich nicht per Ping erreichen, es "geht nichts durch das VPN". Häufigste Ursache ist ein nur auf einer Seite aktiviertes "comp-lzo"
</li></ul><ul><li>Und noch ein Hinweis für die "Windows-Nutzer": Wenn der Rechner, der eine Freigabe hat, nicht im gleichen Netz ist (also zum Beispiel über VPN verbunden ist), muss zum einen die Firewall Zugriffe aus einem anderen Netz zulassen zum anderen funktioniert die Windows Namensauflösung nicht. Kann man im LAN die Freigabe in der Art  <em> <br />Der_PC_mit-Freigabe\meine_Daten </em> <br /> nutzen, so ist das über das VPN nicht möglich. Es gibt dann zwei Möglichkeiten:
<ol><li>Nutzung der IP-Adresse, also <em> <br />192.168.178.12\meine_Daten </em>
</li><li>Nutzung der Datei <em>&lt;Windowsverzeichnis&gt;\system32\drivers\etc\lmhosts</em>, in die man Rechnername und IP einträgt. Dann kann die Freigabe weiterhin über den Namen genutzt werden
</li></ol></li></ul><h2 id="Verschlüsselung:WelcherCipher">Verschlüsselung: Welcher "Cipher" ?</h2>
<p>
Der Verkehr zwischen Client und Server wird normalerweise verschlüsselt übertragen, um die Inhalte vor dem Ausspähen zu schützen.  Die Wahl des Verschlüsselungsalgorithmus erfolg über die "Cipher" Auswahlbox. Momentan sind dort diese Cipher wählbar, in Klammern jeweils die OpenVPN Bezeichnung, wie sie aus dem OpenSSL übernommen wurde:
</p>
<pre class="wiki">Blowfish (BF-CBC)
AES 128 (AES-128-CBC)
AES 256 (AES-256-CBC)
Triple-DES (DES-EDE3-CBC)
</pre><p>
Um die Frage der durch die Verschüsselung erzeugte Last auf der Box nachzugehen, habe ich mal mit <tt>openssl speed des aes blowfish</tt> einen "Leistungsvergleich" der Verfahren auf einem Speedport 701 gemacht (nur für die wählbaren Optionen):
</p>
<pre class="wiki">The 'numbers' are in 1000s of bytes per second processed.
type              16 bytes     64 bytes    256 bytes   1024 bytes   8192 bytes
des cbc           1827.26k     1909.78k     1931.44k     1935.13k     1888.51k
blowfish cbc      2940.90k     3187.67k     3257.75k     3245.84k     3108.06k
aes-128 cbc       1936.58k     1984.45k     2019.82k     2004.45k     1940.50k
aes-256 cbc       1500.48k     1532.26k     1541.70k     1510.14k     1494.16k
</pre><p>
Man sieht, dass von den verfügbaren Algorithmen "Blowfish" den größten Durchsatz hat. Bei intensiver Nutzung könnte das von Interesse sein. Für tiefergehende Vergleiche der Algorithmen sei z.B. auf <a class="ext-link" href="http://en.wikipedia.org/wiki/Block_cipher"><span class="icon">​</span>Wikipedia</a> verwiesen.
</p>
<p>
Zum Vergleich die Zahlen von einer 7320:
</p>
<pre class="wiki">The 'numbers' are in 1000s of bytes per second processed.
type             16 bytes     64 bytes    256 bytes   1024 bytes   8192 bytes
des cbc           2256.44k     2403.96k     2394.38k     2398.15k     2416.23k
des ede3           838.01k      863.05k      852.47k      864.63k      860.43k
blowfish cbc      5949.83k     6772.94k     6777.60k     6852.09k     6858.03k
aes-128 cbc       4218.86k     4641.06k     4719.34k     4722.43k     4723.41k
aes-192 cbc       3731.79k     4053.84k     4106.21k     4079.90k     4176.53k
aes-256 cbc       3312.71k     3596.58k     3627.24k     3628.52k     3678.10k
</pre><p>
&hellip; und von einer 7390:
</p>
<pre class="wiki">The 'numbers' are in 1000s of bytes per second processed.
type             16 bytes     64 bytes    256 bytes   1024 bytes   8192 bytes
des cbc           3020.13k     3136.60k     3153.10k     3178.21k     3166.10k
des ede3          1104.84k     1119.55k     1127.09k     1129.19k     1126.40k
blowfish cbc      8043.34k     8744.39k     8965.62k     8973.62k     8947.55k
aes-128 cbc       5597.86k     6122.27k     6304.22k     6262.31k     6254.70k
aes-192 cbc       4932.01k     5308.92k     5450.89k     5446.16k     5429.97k
aes-256 cbc       4388.37k     4711.52k     4812.80k     4817.99k     4798.96k
</pre><h2 id="DNSRedirectallclientstraffic">DNS &amp; Redirect all clients' traffic</h2>
<p>
I wanted to monitor all traffic coming from my Android device, so I route all my traffic through openVPN and am using tcpdump to see the traffic. I discovered that DNS going to my mobile provider is blocked via by my DSL provider (of course). To circumvent that problem I tried to specific a DNS server using openVPN, but that didn' work. Eventually I fixed this problem by using iptables to re-route DNS to the local DNS server (dnsmasq) like this:
</p>
<pre class="wiki">iptables -A PREROUTING -i tun0 -p tcp -m tcp --dport 53 -j DNAT --to-destination 192.168.178.1
iptables -A PREROUTING -i tun0 -p udp -m udp --dport 53 -j DNAT --to-destination 192.168.178.1
</pre><p>
It is interesting to see what Android is doing &hellip;
</p>
<h2 id="Diskussion">Diskussion</h2>
<p>
Fragen und Anmerkungen zu diesem Paket werden in <a class="ext-link" href="http://www.ip-phone-forum.de/showthread.php?t=101980"><span class="icon">​</span>diesem Thread</a> diskutiert.
</p>
<h2 id="NeuesimpleGUIGUI2">Neue, simple GUI (GUI2)</h2>
<p>
<span class="thumbnail-right"><span class="aux" style="width: 449px;"><a style="border-width: 1px;" href="/screenshots/273?format=raw" title="neue OpenVPN GUI"><img src="/screenshots/273?width=447&amp;format=raw&amp;height=324" alt="neue OpenVPN GUI" /></a><span class="description" style="width: 449px;"><a href="/screenshots/273" title="neue OpenVPN GUI">neue OpenVPN GUI</a></span></span></span>
Aktuell ist im "trunk" (der Freetz Entwicklerversion) eine weitere GUI zum Paket hinzugekommen, die deutlich "schlanker" ist als die bisherige. Sie ist als "simple GUI" für Experten gedacht, die direkt eine Konfigurationsdatei eingeben können.
</p>
<p>
Wichtig:
</p>
<ul><li>Um diese GUI wählen zu können, muss der "Level of user competence" mindestens "Advanced" sein.
</li></ul><p>
Als Option sind zusätzlich Skript-Dateien hinzugekommen, die z.B. als "up"- oder "client-connect"-Skript genutzt werden können.
</p>
<p>
Ein Beispiel sei hier genannt für einen Server mit Zertifikaten, zu dem sich Clients verbinden, zu denen Netze geroutet werden sollen. Damit das funktioniert muss neben dem "normalen" Routing auch das interne Routing des Servers konfiguriert werden, der dazu "iroute" Einträge benötigt.
</p>
<pre class="wiki">mode server
tls-server
port 1194
proto udp
ca /tmp/flash/openvpn/ca.crt
cert /tmp/flash/openvpn/box.crt
key /tmp/flash/openvpn/box.key
dh /tmp/flash/openvpn/dh.pem
dev tun
topology subnet
push "topology subnet"
ifconfig 10.10.10.1 255.255.255.0
cipher AES-128-CBC
verb 3

script-security 2
client-connect "/bin/sh /tmp/flash/openvpn/script1"

daemon
</pre><p>
Um für die Clients IPs zu vergeben wird hier "script1" als client-connect Skript genutzt (ähnlich wie die "erweiterte Clientconfig" der "alten GUI").
Die Idee/Anwendung sollte selbsterklärend sein (hoffe ich):
</p>
<pre class="wiki">#!/bin/sh
CLIENTS='name:ip maske:netz1 maske1; netz2 maske2
Client1:10.10.10.1 255.255.255.0:192.168.100.0 255.255.255.0
Client2:10.10.10.2 255.255.255.0:192.168.200.0 255.255.255.0
Client3:10.10.10.3 255.255.255.0:
Client4:10.10.10.4 255.255.255.0:192.168.104.0 255.255.255.0;192.168.105.0 255.255.255.0
client3:10.10.10.12 255.255.255.0:192.168.104.0 255.255.255.0;192.168.105.0 255.255.255.0
Client5:10.10.10.5 255.255.255.0'

# env will give name of connected client in variable "common_name"
X=$(echo "$CLIENTS" | sed -n "/^${common_name}:/ s/^${common_name}:// p")
CLIENTCONFIG=$1

# if found info on common name, generate client-config
if [ -n "$X" -a -n "$CLIENTCONFIG" ]; then
IP=${X%%:*}
NETS=${X##*:}
[ -n "$IP" ] &amp;&amp; echo "ifconfig-push $IP" &gt; $CLIENTCONFIG
[ -n "$NETS" -a "$NETS" != "$IP" ] &amp;&amp;  echo -e "iroute $NETS" | \
	sed "s/[[:space:]]*;[[:space:]]*/\niroute /g" &gt;&gt; $CLIENTCONFIG
fi

</pre><h3 id="WeitereKonfigsanlegen">Weitere Konfigs anlegen</h3>
<p>
Um weitere Konfigs anzulegen, muss man momentan noch von Hand einmal einen Aufruf machen. Um Beispielsweise eine Config Namens <tt>OpenVPN_TCP</tt> anzulegen:
</p>
<p>
<tt>http://fritz.box:81/cgi-bin/conf/openvpn?genconfigname=OpenVPN_TCP</tt>
</p>
<p>
ACHTUNG: Nicht den Config-Namen "OpenVPN" oder "openvpn" verwenden!
</p>
</div>

      </div><ul class="tags"><li class="header">Tags</li><li><a href="/tags/network" rel="tag">network</a> </li><li><a href="../packages.html" rel="tag">packages</a> </li><li><a href="/tags/routing" rel="tag">routing</a> </li><li><a href="/tags/security" rel="tag">security</a> </li><li><a href="/tags/vpn" rel="tag">vpn</a> </li></ul>

    </div>
    <script type="text/javascript">
        jQuery.loadStyleSheet("/chrome/screenshots/css/screenshots.css", "text/css");
    </script>
    </div>
  </body>
</html>
