<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  


  <head>
    <title>
      packages/usbroot – Freetz
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="http://freetz.org/search" />
        <link rel="help" href="../TracGuide.html" />
        <link rel="alternate" href="usbroot%3Fformat=txt" type="text/x-trac-wiki" title="Reiner Text" />
        <link rel="up" href="../packages.html" title="Übergeordnete Wiki-Seite anzeigen" />
        <link rel="start" href="http://freetz.org/wiki" />
        <link rel="stylesheet" href="../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../chrome/common/css/wiki.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/phrases.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes-300.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes-narrow-toc.css" type="text/css" /><link rel="stylesheet" href="../../wikicss.css" type="text/css" /><link rel="stylesheet" href="../../chrome/tags/css/tractags.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikinegotiator/css/langmenu-ctxnav.css" type="text/css" />
        <link rel="shortcut icon" href="http://freetz.org/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="http://freetz.org/favicon.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="http://freetz.org/search/opensearch" title="Freetz durchsuchen" />
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/jquery.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/babel.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/messages/de.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/trac.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/search.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/folding.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $("#content").find(".wikianchor").each(function() {
          $(this).addAnchor(babel.format(_("Link to #%(id)s"), {id: $(this).attr('id')}));
        });
        $(".foldable").enableFolding(true, true);
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://freetz.org/wiki"><img src="../../chrome/common/freetz_motd.png" alt="Freetz" /></a>
      </div>
      <form id="search" action="http://freetz.org/search" method="get">
        <div>
          <label for="proj-search">Suche:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Suche" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="http://freetz.org/login">Anmelden</a></li><li><a href="http://freetz.org/prefs">Einstellungen</a></li><li><a href="../TracGuide.html">Hilfe/Anleitung</a></li><li><a href="http://freetz.org/about">Über Trac</a></li><li><a href="http://freetz.org/notification" title="Wiki Pages Change Notifications">My Notifications</a></li><li><a href="http://freetz.org/register">Registrieren</a></li><li class="last"><a href="../Impressum.html">Impressum</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="http://freetz.org/wiki">Wiki</a></li><li><a href="http://freetz.org/timeline">Journal</a></li><li><a href="http://freetz.org/roadmap">Projektplan</a></li><li><a href="http://freetz.org/browser">Quellen durchsehen</a></li><li><a href="http://freetz.org/report">Tickets anzeigen</a></li><li><a href="http://freetz.org/search">Suche</a></li><li><a href="http://freetz.org/tags">Tags</a></li><li><a href="http://freetz.org/downloads">Downloads</a></li><li class="last"><a href="http://freetz.org/screenshots">Bildschirmfotos</a></li>
    </ul>
  </div>
    <div id="langmenu"><ul><li class="first"><span title="Select a language of wiki content">Language:</span></li><li class=" active"><a class="" href="usbroot..html" title="displaying language (default)">German</a></li><li class=" last"><a class=" notexist" href="http://freetz.org/wiki/packages/usbroot.en" title="(not available)">English</a></li></ul></div><div id="main">
      <div id="pagepath" class="noprint">
  <a class="pathentry first" title="Zeige WikiStart an" href="http://freetz.org/wiki">Wiki:</a><a class="pathentry" href="../packages.html" title="Zeige packages an">packages</a><span class="pathentry sep">/</span><a class="pathentry" href="usbroot.html" title="Zeige packages/usbroot an">usbroot</a>
</div>
      <div id="ctxtnav" class="nav">
        <h2>Kontext-Navigation</h2>
        <ul>
          <li class="first"><a href="../packages.html">Aufwärts</a></li><li><a href="../WikiStart.html">Startseite</a></li><li><a href="../TitleIndex.html">Inhaltsverzeichnis</a></li><li><a href="usbroot%3Faction=history.html">Änderungshistorie</a></li><li class="last"><a href="http://freetz.org/notification/packages/usbroot" title="Watch Page">Watch Page</a></li>
        </ul>
        <hr />
      </div>
    <div id="content" class="wiki">
      <div class="wikipage searchable">
        
          <div id="wikipage" class="trac-content"><p>
</p><div class="wiki-toc"><h4>Inhaltsverzeichnis</h4><ol><li><a href="usbroot.html#Vorteile">Vorteile</a></li><li><a href="usbroot.html#KonfigurationundKompilierung">Konfiguration und Kompilierung</a></li><li><a href="usbroot.html#PackenkopierenaufdieFritzBoxundentpacken">Packen, kopieren auf die Fritz!Box und entpacken</a></li><li><a href="usbroot.html#EinbindenvonPartitionen">Einbinden von Partitionen</a></li><li><a href="usbroot.html#MöglicheNebenwirkungen">Mögliche Nebenwirkungen</a></li><li><a href="usbroot.html#Verbesserungsmöglichkeiten">Verbesserungsmöglichkeiten</a></li></ol></div><p>
</p>
<h1 id="USB-Root">USB-Root</h1>
<p>
Mit <strong>USB-Root</strong> lässt sich das Root-Verzeichnis (<tt>/</tt>) auf ein an die Fritz!Box angeschlossenes USB-Gerät auslagern - was zusätzlichen Platz nicht nur für weitere Software schafft.
</p>
<h2 id="Vorteile">Vorteile</h2>
<ul><li>Immer noch ein lauffähiges System im Flash-Speicher der Fritz!Box als Notfall-System vorhanden 
</li><li>Nahezu unbegrenzter Platz
</li><li>Mehrere Systeme parallel zur Auswahl auf dem USB-Stick &rarr; einfaches Testen neuer Versionen und Konfigurationen. Dabei sollte allerdings die jeweils genutzte Firmwarebasis von AVM ein zueinander kompatibles Konfigurationsformat aufweisen!  
</li></ul><p>
<strong>Ein Beispiel aus der Praxis:</strong>
</p>
<p>
Annex A Box in Frankreich mit DAU als Besitzer <img src="../../chrome/wikiextras-icons-16/smiley-wink.png" style="vertical-align: text-bottom" alt=";-)" /> Bei einem nicht funktionierenden System im Flash würde da gar nichts mehr gehen. Strom aus, USB-Stick ab und Strom wieder an, bekommt er aber hin um damit das Notfallsystem im Flash nutzen zu können.  
</p>
<h2 id="KonfigurationundKompilierung">Konfiguration und Kompilierung</h2>
<p>
USB-Root muss einfach bei Erstellung des Images mit <tt>make menuconfig</tt> (siehe <a class="missing wiki">Freetz Installation?</a>) mit ausgewählt werden. Um später eine Shell auf der Fritz!Box zu haben und scp nutzen zu können, sollte auch dropbear mit ins Image. Zuerst wird dann ein Image mit USB-Root erzeugt, das in den Flashspeicher der Fritz!Box passt und dann auch wie jedes Image auf die Fritz!Box geflasht wird.
</p>
<p>
Dann kann man sich sein System für den USB-Root zusammen stellen und braucht nicht mehr auf den Platz zu achten. Das USB-Root Paket muss jedoch ausgewählt bleiben! Die Fehlermeldung am Ende, dass das Image zu groß ist, stört hier nicht weiter. Wir benötigen ja nur das erstellte Systeme, das wir in [Freetz-Ordner]/build/modified/filesystem finden.
</p>
<p>
Es kann eine beliebige Freetz-Version für den USB-Stick verwendet werden. Es muss nicht die gleiche Version verwendet werden, wie sie im Flashspeicher der Fritz!Box abgelegt ist.  Es muss ausschließlich der Kernel im Flashspeicher zum Kernel des USB-Sticks passen. 
</p>
<p>
Als Dateisystem ist eine Partition mit ext2 oder ext3 zu verwenden. Das passende Kernel-Modul muss bei der Imageerstellung ausgewählt werden!
</p>
<h2 id="PackenkopierenaufdieFritzBoxundentpacken">Packen, kopieren auf die Fritz!Box und entpacken</h2>
<div class="code"><pre>
<span class="c"># 1. Dateisystem packen, dabei Besitzer auf root:root ändern
</span>tar --group<span class="o">=</span>0 --owner<span class="o">=</span>0 -czf rootfs.tar.gz -C build/modified/filesystem .

<span class="c"># 2. USB-Root im Freetz-Web deaktivieren, falls bereits aktiv
</span>
<span class="c"># 3. Box mit Firmware aus dem Flash neu starten
</span>
<span class="c"># 4. Archiv direkt auf an der Box angeschlossenes USB-Medium kopieren (Zielpfad anpassen!)
</span>
<span class="c"># Variante A: vom PC aus die Datei auf die Box schieben (benötigt SSH-Server auf der Box)
</span>scp rootfs.tar.gz root@fritz.box:/var/media/ftp/uStor01/rootfs

<span class="c"># Variante B: von der Box aus die Datei vom PC holen (benötigt SSH-Server auf dem PC)
</span>scp user@my_pc:/home/user/freetz-trunk/rootfs.tar.gz /var/media/ftp/uStor01/rootfs

<span class="c"># 5. Archiv auf der Box entpacken
</span><span class="nb">cd</span> /var/media/ftp/uStor01/rootfs
tar -xzf rootfs.tar.gz

<span class="c"># 6. Falls USB-Root noch nicht genutzt wurde muss es erst im Freetz-Web konfiguriert werden (Partition auswählen und Verzeichnis eintragen (z.B. /rootfs)
</span>
<span class="c"># 7. USB-Root in Freetz-Web aktivieren, Box vom USB-Root neu starten
</span></pre></div><p>
<strong>Neu in der Entwicklerversion seit <a class="changeset" href="http://freetz.org/changeset/8566" title="Major build system enhancements (needs more testing, please don't kill me ...">r8566</a>:</strong> Man kann direkt in <em>Menuconfig</em> einstellen, daß beim Build zusätzlich zum oder anstelle des Firmware-Images das Dateisystem direkt in ein Archiv gepackt wird ("USB Root Mode", ersetzt Schritt 1 oben). Alternativ ist es über den "NFS Root Mode" auch möglich, das Dateisystem direkt (fix und fertig entpackt, Schritte 1, 3, 4) auf den USB-Stick zu kopieren, sofern dieser am PC angeschlossen oder über NFS erreichbar ist. Erstere Variante ist vermutlich die häufigere und sieht so aus:
</p>
<pre class="wiki">Freetz Configuration
====================

[*] Show advanced options
--&gt; Advanced options
    --&gt; Build system options
        --&gt; Firmware packaging (fwmod) special options
            [*] Skip packing modified firmware
            [*] Pack file system into archive (USB root mode)
</pre><h2 id="EinbindenvonPartitionen">Einbinden von Partitionen</h2>
<p>
Das Einbinden von weiteren Partitionen funktionierte in frühen Freetz-Versionen nicht, somit mussten diese Partitionen manuell eingebunden werden. In aktuellen Freetz-Versionen funktioniert dies nun, so dass die AVM-Features, welche auf USB-Partitionen speichern, verwendet werden können.
</p>
<p>
Allerdings gibt es beim Mounten der Partitionen eine Fehlermeldung für die verwendete Root-Partition: da diese bereits gemountet ist, schlägt ein weiterer Mount-Versuch (der "normale" von AVM) natürlich fehl. Dies kann mit ruhigem Gewissen ignoriert werden.
</p>
<h2 id="MöglicheNebenwirkungen">Mögliche Nebenwirkungen</h2>
<p>
Das Freetz usbroot Paket verändert die Environment-Variable kernel_args und startet dort einen alternativen init Prozess (init=/etc/init.d/rc.usbroot). Die Variable kernel_args1 wird auch gesetzt. Beim Upgrade / Recover der Firmware kann dies zu Problemen führen, daher <strong>MUSS vor dem Firmware-Update bzw Recover die usbroot-Funktion wieder deaktiviert werden''', wahlweise über das Freetz Webinterface oder aus der Shell mit:
</strong></p>
<pre class="wiki">echo kernel_args &gt; /proc/sys/urlader/environment
echo kernel_args1 &gt; /proc/sys/urlader/environment
</pre><p>
Bemerkt man dies zu spät (Die Box startet als Beispiel gleich nach 5 Sekunden neu) helfen die ADAM2 Befehle:
</p>
<pre class="wiki">quote SETENV kernel_args
quote SETENV kernel_args1
</pre><p>
Sollte es nach den beiden Befehlen immernoch nicht helfen, so führt man ein Recover aus und flasht danach ein Freetz <strong>ohne jediglichen Umfang</strong> (ohne Packages sowie <strong>ohne</strong> usbroot) über das AVM-WebInterface auf die Box und setzt die beiden Variablen (mittels Telnet) wieder auf ihren normalwert, danach kann man wieder problemlos seine gewünschte modifizierte Firmware auf die Box bringen!
</p>
<h2 id="Verbesserungsmöglichkeiten">Verbesserungsmöglichkeiten</h2>
<ol><li>Direkt per SCP oder rsync aus der Stinky-VM auf die Fritz!Box kopieren. <br /> Wenn man aus Buildsystem (z.B. VM mit STinky) direkt über Netzwerk die Fritz!Box per ssh/scp erreichen kann ist der Umweg über einen weiteren PC unnötig. Hier wäre es dann eine direkte Verbindung zwischen Fritz!Box und Buildsystem eleganter. Die Variante oben ist aber für entfernte Systeme, ohne von außen erreichbaren SSH-Zugang weiterhin brauchbar.  
</li><li>Die sich wiederholenden Befehle in ein bash-script packen
</li></ol></div>
          
          <div class="trac-modifiedby">
            <span><a href="usbroot%3Faction=diff&amp;version=20.html" title="Version 20 von oliver: Nummerierung korrigiert">zuletzt geändert</a> <a class="timeline" href="http://freetz.org/timeline?from=2014-02-15T11%3A12%3A00Z&amp;precision=second" title="Siehe Journal am 15.02.2014 11:12:00">vor 4 Jahren</a></span>
            <span class="trac-print">Zuletzt geändert am 15.02.2014 11:12:00</span>
          </div>
        
        
      </div><ul class="tags"><li class="header">Tags</li><li><a href="http://freetz.org/tags/filesystem" rel="tag">filesystem</a> </li><li><a href="../packages.html" rel="tag">packages</a> </li><li><a href="http://freetz.org/tags/usb" rel="tag">usb</a> </li></ul>
      

    </div>
    <script type="text/javascript">
        jQuery.loadStyleSheet("/pygments/trac.css", "text/css");
    </script>
    <div id="altlinks">
      <h3>In anderen Formaten herunterladen:</h3>
      <ul>
        <li class="last first">
          <a rel="nofollow" href="usbroot%3Fformat=txt">Reiner Text</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Betrieben mit <a href="http://freetz.org/about"><strong>Trac 1.0.1</strong></a><br />
        von <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right"><div class="field" align="right"><form action="https://www.paypal.com/cgi-bin/webscr" method="post"><input type="hidden" name="cmd" value="_donations"/><input type="hidden" name="business" value="spenden@freetz.org"/><input type="hidden" name="item_name" value="Freetz Entwickler-Team"/><input type="hidden" name="no_shipping" value="1"/><input type="hidden" name="return" value="http://freetz.org"/><input type="hidden" name="cn" value="Name oder IPPF-Pseudonym"/><input type="hidden" name="currency_code" value="EUR"/><input type="hidden" name="tax" value="0"/><input type="hidden" name="lc" value="DE"/><input type="hidden" name="bn" value="PP-DonationsBF"/><input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="Zahlen Sie mit PayPal - schnell, kostenlos und sicher!"/><img alt="" border="0" src="http://freetz.org/pixel.gif" width="1" height="1"/></form></div></p>
    </div>
  </body>
</html>