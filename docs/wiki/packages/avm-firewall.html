<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  


  <head>
    <title>
      packages/avm-firewall – Freetz
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="/search" />
        <link rel="help" href="../TracGuide.html" />
        <link rel="alternate" href="avm-firewall%3Fformat=txt" type="text/x-trac-wiki" title="Reiner Text" />
        <link rel="up" href="../packages.html" title="Übergeordnete Wiki-Seite anzeigen" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../chrome/common/css/wiki.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/phrases.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes-300.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikiextras/css/boxes-narrow-toc.css" type="text/css" /><link rel="stylesheet" href="../../wikicss.css" type="text/css" /><link rel="stylesheet" href="../../chrome/tags/css/tractags.css" type="text/css" /><link rel="stylesheet" href="../../chrome/wikinegotiator/css/langmenu-ctxnav.css" type="text/css" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Freetz durchsuchen" />
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/jquery.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/babel.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/messages/de.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/trac.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/search.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../chrome/common/js/folding.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $("#content").find(".wikianchor").each(function() {
          $(this).addAnchor(babel.format(_("Link to #%(id)s"), {id: $(this).attr('id')}));
        });
        $(".foldable").enableFolding(true, true);
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="/wiki"><img src="../../chrome/common/freetz_motd.png" alt="Freetz" /></a>
      </div>
      <form id="search" action="https://www.google.com/search" method="get" onsubmit="; this.elements.namedItem('q').value = this.elements.namedItem('oq').value + ' site:freetz.github.io'">
        <div>
          <label for="proj-search">Suche:</label>
          <input type="text" id="proj-search" name="oq" size="18" value="" />
          <input type="hidden" name="q" value="" />
          <input type="submit" value="Suche" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/login">Anmelden</a></li><li><a href="/prefs">Einstellungen</a></li><li><a href="../TracGuide.html">Hilfe/Anleitung</a></li><li><a href="/about">Über Trac</a></li><li><a href="/notification" title="Wiki Pages Change Notifications">My Notifications</a></li><li><a href="/register">Registrieren</a></li><li class="last"><a href="../Impressum.html">Impressum</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="/wiki">Wiki</a></li><li><a href="/timeline">Journal</a></li><li><a href="/roadmap">Projektplan</a></li><li><a href="/browser">Quellen durchsehen</a></li><li><a href="/report">Tickets anzeigen</a></li><li><a href="/search">Suche</a></li><li><a href="/tags">Tags</a></li><li><a href="/downloads">Downloads</a></li><li class="last"><a href="/screenshots">Bildschirmfotos</a></li>
    </ul>
  </div>
    <div id="langmenu"><ul><li class="first"><span title="Select a language of wiki content">Language:</span></li><li class=" active"><a class="" href="avm-firewall.html" title="displaying language (default)">German</a></li><li class=" last"><a class=" notexist" href="/wiki/packages/avm-firewall.en" title="(not available)">English</a></li></ul></div><div id="main">
      <div id="pagepath" class="noprint">
  <a class="pathentry first" title="Zeige WikiStart an" href="/wiki">Wiki:</a><a class="pathentry" href="../packages.html" title="Zeige packages an">packages</a><span class="pathentry sep">/</span><a class="pathentry" href="avm-firewall.html" title="Zeige packages/avm-firewall an">avm-firewall</a>
</div>
      <div id="ctxtnav" class="nav">
        <h2>Kontext-Navigation</h2>
        <ul>
          <li class="first"><a href="../packages.html">Aufwärts</a></li><li><a href="../index.html">Startseite</a></li><li><a href="../TitleIndex.html">Inhaltsverzeichnis</a></li><li><a href="avm-firewall%3Faction=history.html">Änderungshistorie</a></li><li class="last"><a href="/notification/packages/avm-firewall." title="Watch Page">Watch Page</a></li>
        </ul>
        <hr />
      </div>
    <div id="content" class="wiki">
      <div class="wikipage searchable">
        
          <div id="wikipage" class="trac-content"><h1 id="AVM-firewall-cgi">AVM-firewall-cgi</h1>
<p>
Das <strong>AVM-firewall-CGI</strong> stellt eine Web-Oberfläche dar, mit der man die von AVM dem User vorenthaltene integrierte Firewall administrieren kann. Die Firewall ist ein Bestandteil des "dsld" von AVM, deshalb kann man diese Firewall nicht wirklich starten oder stoppen, sie läuft eigentlich immer (solange dsld auf der Box ist).
</p>
<p>
<span class="thumbnail-right"><span class="aux" style="width: 202px;"><a style="border-width: 1px;" href="/screenshots/10?format=raw" title="AVM firewall forward rule example"><img src="/screenshots/10?width=200&amp;format=raw&amp;height=145" alt="AVM firewall forward rule example" /></a><span class="description" style="width: 202px;"><a href="/screenshots/10" title="AVM firewall forward rule example">Portforwarding am Bsp. OpenVPN</a></span></span></span>
</p>
<p>
Ein paar Worte zu den "Grundlagen" und der Philosophie, die AVM damit umsetzt:
</p>
<ul><li>Die Firewall von AVM ist wohl konzipiert als eine "Zusatzfirewall"
</li><li>Die "Firewall" ist jeweils vorgeschaltet und wirkt auf Pakete, die <em>vom</em> WAN-Interface kommen oder <em>zum</em> WAN gehen. Box-intern wirkt sie nicht.
</li><li>Die Box hat für das WAN-Interface eine zweite (die "eigentliche") Sicherung: Alle eingehenden Pakete, für die es keinen Eintrag in der NAT-Tabelle gibt, werden verworfen.
</li></ul><p>
Diese NAT-Einträge geschehen entweder dynamisch (wenn aus dem LAN ins Internet zugegriffen wird), oder statisch, wenn Einträge im "Portforwarding" existieren. Dieses Verfahren gilt immer, auch die Box-Prozesse selbst akzeptieren keine Pakete, ohne eine solche NAT, daher gibt es dafür die Portweiterleitungen "auf die Box selbst".
</p>
<p>
Die Firewall filtert also nur zusätzlich Pakete heraus, die eigentliche "Sicherheit" wird über den "NAT-Mechanismus" realisiert. Deshalb ist die "Default-Einstellung" der Firewall auch für alle nicht verbotenen Pakete: Permit.
</p>
<p>
Wirklich wirksam wird diese Firewall deshalb zum einen, um ausgehend bestimmte Verbindungen zu blocken, oder aber, wenn man sich "viel Arbeit macht" und alle benötigten Verbindungen erlaubt und dann die Default-Regel auf "Deny" stellt.
</p>
<p>
Ich persönlich (ich hoffe, auch als "Autor" darf ich das sagen) würde für tiefergehende Eingriffe eher auf <a class="wiki" href="iptables.html">iptables</a> zurückgreifen&hellip;
</p>
<h2 id="Feature-Übersicht">Feature-Übersicht</h2>
<p>
<span class="thumbnail-right"><span class="aux" style="width: 212px;"><a style="border-width: 1px;" href="/screenshots/100?format=raw" title="AVM Firewall cgi"><img src="/screenshots/100?width=210&amp;format=raw&amp;height=186" alt="AVM Firewall cgi" /></a><span class="description" style="width: 212px;"><a href="/screenshots/100" title="AVM Firewall cgi">AVM Firewall cgi</a></span></span></span> Mit AVM-FIREWALL-CGI kann man direkt über eine Weboberfläche Folgendes tun:
</p>
<ul><li>Die von AVM vordefinierten Firewallregeln ändern/löschen
</li><li>Eigene Regeln hinzufügen (sehr praktisch um lästiges "nach Hause telefonieren" von mancher Software im Router zu unterbinden)
</li><li>Portforwardings erstellen, die auch auf die Fritz selber (0.0.0.0) zeigen können.(z.B. für FTP oder webserver Freigaben ins I-Net)
</li></ul><p>
Die Syntax sollte nicht weiter schwer sein, dafür gibt es ja die Dropdown-Felder.
</p>
<h2 id="AnwendungdergeändertenRegeln">Anwendung der geänderten Regeln</h2>
<p>
Die Tatsache, dass AVM entweder keine Änderungen am Regelwerk vorsieht (bei der Firewall) oder selbst die Änderungen verwaltet (Forwarding), erfordert besondere Maßhnahmen, um die in der GUI vorgenommenen Änderungen auch anzuwenden. Hierfür werden AVM-Dienste neu gestartet, was zum Crash der Box und sogar zum Reset auf Werkseinstellungen führen kann, deshalb am Ende der Seite die animierte Grafik zur Warung.
</p>
<p>
Um allen Problemen aus dem Weg zu gehen sollte der "Übernehmen" Haken <strong>nicht</strong> gesetzt werden, sondern die Regeln "nur" abgespeichert und die Box dann neu gestartet.
</p>
<p>
<strong>Ergänzung zur Trunk-Version, Stand 22.02.2010</strong> In dieser Version sind jetzt vier Auswahlpunkte zur Übernahme der Regelwerke vorgesehen, um die beschriebenen Crash-Probleme besser eingrenzen zu können (sihe Bild unten). Hier eine Kurze Erläuterung dazu:<br /> Die GUI tangiert zwei AVM Daemons (ctlmgr und dsld) und zwar deshalb, weil im <em>dsld</em> die Regeln tatsächlich wirken, im <em>ctlmgr</em>, weil der die eigene Regelverwaltung macht.
</p>
<ul><li>In der Freetz-GUI vorgenommenen Änderungen sind der AVM-"Regelverwaltung" unbekannt. Deshalb muss der <em>ctlmgr</em> neu gestartet werden, um diese Änderunegen dort auch zu verankern. Wird der ctlmgr nicht neu gestartet, können Änderungen in der AVM-GUI alle Änderungen in dieser GUI (sowohl in der Firewall als auch im Forwarding) rückgängig machen.
</li><li>Um <strong>Firewall-Änderungen</strong> zu aktivieren, muss der dsld gestoppt und neu gestartet werden
</li><li>Um Änderungen an den <strong>Optionen des dsld</strong> zu aktivieren, ist ebenfalls ein Neustart des dsld erforderlich
</li><li>Um <strong>Portforwarding-Änderungen</strong> zu übernehmen, muss der dsld nicht komplett neu gestartet werden, es reicht, ihn über ein Signal (HUP) "anzuweisen", die Regeln neu zu laden und anzuwenden.
</li></ul><p>
<span class="thumbnail"><span class="aux" style="width: 464px;"><a style="border-width: 1px;" href="/screenshots/145?format=raw" title="AVM firewall - Übernehmen Parameter (Trunk Version)"><img src="/screenshots/145?width=462&amp;format=raw&amp;height=84" alt="AVM firewall - Übernehmen Parameter (Trunk Version)" /></a><span class="description" style="width: 464px;"><a href="/screenshots/145" title="AVM firewall - Übernehmen Parameter (Trunk Version)">AVM firewall - Übernehmen Parameter (Trunk Version)</a></span></span></span>
</p>
<h2 id="DieGefahrvonReboot-Schleifenundwiemandawiederherauskommt">Die Gefahr von Reboot-Schleifen und wie man da wieder herauskommt</h2>
<p>
Bei zahlreichen Versuchen mit der Einrichtung von Firewallregeln mit Hilfe dieses CGI-Paketes hat sich gezeigt, daß man die Box bei umfangreichen Änderungen dazu bringen kann, immer wieder neu zu starten. Das geschieht auch bei völlig legitimen Regeln und scheint mit dem Umfang des Regelsatzes zusammenzuhängen. Subjektiv erscheinen mir Portsperren unkritischer als IP-Bereichssperren über Subnetzadressen und -Masken. Aufgetreten ist das bei mir auf einer 7270v3 mit 74.04.88 und Freetz 1.2 Revision 7500; ein anderer Nutzer berichtete gleiches von einer 7390.
</p>
<p>
Die Ursache des Problems liegt irgendwo im „dsld“ von AVM begraben, der auch die Firewall-Funktion bereitstellt und ist inziwschen insbesondere dank <a class="ext-link" href="http://www.ip-phone-forum.de/member.php?u=62478"><span class="icon">​</span>„MaxMuster“</a> ergründet (siehe dazu die „Literaturhinweise“ aus dem IP-Phone-Forum am Ende dieser Seite).
</p>
<h3 id="Abhilfe">Abhilfe</h3>
<p>
AVM hat nach dem Hinweis auf die hier beschriebenen Sachverhalte den Fehler gefunden und will ihn in der nächsten Laborversion der Firmware beheben. Die X.05.05-Versionen sind auf jeden Fall noch betroffen. Bis dahin kann es helfen, wenn man beim Erstellen von Firewall-Regeln die folgenden Hinweise beachtet.
</p>
<p>
Es dürfen nicht mehr als jeweils drei „gleichartige“ Regeln für das Protokoll „IP“ unmittelbar hintereinander stehen. Die folgenden Typen sind betroffen:
</p>
<ul><li>„ip reject […]“
</li><li>„ip deny […]“
</li><li>„ip permit […]“
</li></ul><p>
Man muß also nach spätestens drei Zeilen, die mit „ip reject“ beginnen, mindestens eine andere Zeile einfügen, so daß nie mehr als drei Zeilen gleichen „Typs“ aufeinanderfolgen. Port-Forward-Regeln und Port-Sperren scheinen nicht betroffen zu sein, letztere können aber mit den anderen Zeilen gemischt werden, um den Fehler zu verhindern. Wenn man nicht genügend „andersartige“ Regeln hat, kann man bereits bestehende wiederholen oder andere wirkungslose Regeln einfügen.
</p>
<p>
Bei zwei 7270 hat diese Vorgehensweise reproduzierbar funktioniert. In einem Fall, bei der schon erwähnten 7390, scheint das nicht ausreichend gewesen zu sein.
</p>
<h3 id="AnleitungumeineversehentlichausgelösteReboot-Schleifezubeenden">Anleitung, um eine versehentlich ausgelöste Reboot-Schleife zu beenden</h3>
<p>
Die folgende Lösung funktioniert nur, wenn tatsächlich eine Firewall-Änderung die Neustarts verursacht und ist kein Allheilmittel für Neustart-Schleifen. Sie funktioniert auch nicht, wenn der Router im Ethernet-Modus läuft, also die ADSL-Verbindung nicht selber aufbaut. Getestet ist sie nur im gewöhnlichen ADSL-Router-Modus, also ohne externes Modem. Den Flash-Speicher mit einer Sicherheitskopie zu überschreiben ist in diesem speziallen Fall unnötig, gleichwohl sollte man unbedingt eine funktionierende Komplettsicherung und alles nötige für eine Wiederherstellung bereitliegen haben, wenn man an der AVM-Firewall Änderungen vornimmt.
</p>
<p>
Glücklicherweise erfolgt in dem Fall kein Neustart, wenn man den ADSL-Verbindungsaufbau unterbindet, das heißt, das ADSL-Kabel vom Splitter abzieht. Das analoge oder ISDN-Telefonkabel kann steckenbleiben, man hat also während der Reparaturzeit kein Internet, wohl aber Telefon zur Verfügung, das Risiko von Experimenten mit der Firewall ist also kleiner, als man auf den ersten Blick denkt, wenn man was von „Reboot-Schleifen“ liest.
</p>
<h4 id="WiealsoerkenneichdaßsoeineReboot-Schleifestattfindet">Wie also erkenne ich, daß so eine „Reboot-Schleife“ stattfindet?</h4>
<p>
Der Router zeigt dabei die typischen „Start-Blink-Sequenzen“ der Leuchtdioden. Wenn man es immer wieder probiert, kommt man zwar kurz ins Webinterface hinein, aber ein paar Sekunden später „hängt“ es schon wieder, die Zeit reicht nicht, um die letzten Änderungen rückgängig zu machen. Das liegt daran, daß alles normal läuft, bis die Internet-Verbindung aufgebaut wird, dabei stürzt der Kernel dann ab.
</p>
<h4 id="WiebehebeichdasProblemohneFTP-Flash">Wie behebe ich das Problem ohne FTP-Flash?</h4>
<ol><li>Das ADSL-Kabel vom Splitter ziehen.
</li><li>Warten, bis der Router ordentlich gestartet hat und das Freetz-CGI wieder läuft. (Das kann etwas dauern, je nachdem welcher Paketumfang in Freetz installiert ist, kommen nicht alle Programme fast gleichzeitig hoch.)
</li><li>Die Firewalländerungen zurücknehmen, die den Fehler verursacht haben.
</li><li>Neustart über das Freetz-Webinterface anstoßen.
</li><li>Das ADSL-Kabel wieder einstecken.
</li></ol><p>
<a class="ext-link" href="http://www.ip-phone-forum.de/member.php?u=121255"><span class="icon">​</span>Christoph Franzen</a>
</p>
<h2 id="Verweise">Verweise</h2>
<p>
Im <a class="ext-link" href="http://www.ip-phone-forum.de"><span class="icon">​</span>IP-Phone-Forum</a> gibt es zur AVM Firewall einige Threads, z.B.:
</p>
<ul><li><a class="ext-link" href="http://www.ip-phone-forum.de/showthread.php?t=238901"><span class="icon">​</span>instabile AVM-Firewall auf 7270</a> (aktueller Diskussions-Thread)
</li><li><a class="ext-link" href="http://www.ip-phone-forum.de/showthread.php?t=156778"><span class="icon">​</span>Aufruf zur Dokumentation der internen Firewall</a>
</li><li><a class="ext-link" href="http://www.ip-phone-forum.de/showthread.php?t=159802"><span class="icon">​</span>(NEU) AVM-Firewall package für Freetz</a>
</li><li><a class="ext-link" href="http://www.realriot.de/2007/05/die-interne-fritzbox-stateful-firewall_30.html"><span class="icon">​</span>Blog von real-riot</a>
</li></ul></div>
          
          <div class="trac-modifiedby">
            <span><a href="avm-firewall%3Faction=diff&amp;version=22.html" title="Version 22 von neomabre: noch mehr sprachliche Fehler gefunden">zuletzt geändert</a> <a class="timeline" href="/timeline?from=2012-10-03T11%3A42%3A58Z&amp;precision=second" title="Siehe Journal am 03.10.2012 11:42:58">vor 5 Jahren</a></span>
            <span class="trac-print">Zuletzt geändert am 03.10.2012 11:42:58</span>
          </div>
        
        
      </div><ul class="tags"><li class="header">Tags</li><li><a href="/tags/cgi" rel="tag">cgi</a> </li><li><a href="/tags/firewall" rel="tag">firewall</a> </li><li><a href="/tags/network" rel="tag">network</a> </li><li><a href="../packages.html" rel="tag">packages</a> </li><li><a href="/tags/security" rel="tag">security</a> </li></ul>
      

    </div>
    <script type="text/javascript">
        jQuery.loadStyleSheet("/chrome/screenshots/css/screenshots.css", "text/css");
    </script>
    <div id="altlinks">
      <h3>In anderen Formaten herunterladen:</h3>
      <ul>
        <li class="last first">
          <a rel="nofollow" href="avm-firewall%3Fformat=txt">Reiner Text</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Betrieben mit <a href="/about"><strong>Trac 1.0.1</strong></a><br />
        von <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right"><div class="field" align="right"><form action="https://www.paypal.com/cgi-bin/webscr" method="post"><input type="hidden" name="cmd" value="_donations"/><input type="hidden" name="business" value="spenden@freetz.org"/><input type="hidden" name="item_name" value="Freetz Entwickler-Team"/><input type="hidden" name="no_shipping" value="1"/><input type="hidden" name="return" value=""/><input type="hidden" name="cn" value="Name oder IPPF-Pseudonym"/><input type="hidden" name="currency_code" value="EUR"/><input type="hidden" name="tax" value="0"/><input type="hidden" name="lc" value="DE"/><input type="hidden" name="bn" value="PP-DonationsBF"/><input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="Zahlen Sie mit PayPal - schnell, kostenlos und sicher!"/><img alt="" border="0" src="/pixel.gif" width="1" height="1"/></form></div></p>
    </div>
  </body>
</html>