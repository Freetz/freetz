<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <title>
      help/howtos/development/repack_fw – Freetz
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="/search" />
        <link rel="help" href="../../../TracGuide.html" />
        <link rel="alternate" href="repack_fw%3Fformat=txt" type="text/x-trac-wiki" title="Reiner Text" />
        <link rel="up" href="../development.html" title="Übergeordnete Wiki-Seite anzeigen" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="../../../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../../../chrome/common/css/wiki.css" type="text/css" /><link rel="stylesheet" href="../../../../chrome/wikiextras/css/phrases.css" type="text/css" /><link rel="stylesheet" href="../../../../chrome/wikiextras/css/boxes.css" type="text/css" /><link rel="stylesheet" href="../../../../chrome/wikiextras/css/boxes-300.css" type="text/css" /><link rel="stylesheet" href="../../../../chrome/wikiextras/css/boxes-narrow-toc.css" type="text/css" /><link rel="stylesheet" href="../../../../wikicss.css" type="text/css" /><link rel="stylesheet" href="../../../../chrome/tags/css/tractags.css" type="text/css" /><link rel="stylesheet" href="../../../../chrome/wikinegotiator/css/langmenu-ctxnav.css" type="text/css" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Freetz durchsuchen" />
      <script type="text/javascript" charset="utf-8" src="../../../../chrome/common/js/jquery.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../chrome/common/js/babel.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../chrome/common/js/messages/de.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../chrome/common/js/trac.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../chrome/common/js/search.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../chrome/common/js/folding.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $("#content").find(".wikianchor").each(function() {
          $(this).addAnchor(babel.format(_("Link to #%(id)s"), {id: $(this).attr('id')}));
        });
        $(".foldable").enableFolding(true, true);
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="/wiki"><img src="../../../../chrome/common/freetz_motd.png" alt="Freetz" /></a>
      </div>
      <form id="search" action="https://www.google.com/search" method="get" onsubmit="; this.elements.namedItem('q').value = this.elements.namedItem('oq').value + ' site:freetz.github.io'">
        <div>
          <label for="proj-search">Suche:</label>
          <input type="text" id="proj-search" name="oq" size="18" value="" />
          <input type="hidden" name="q" value="" />
          <input type="submit" value="Suche" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><li class="last"><a href="../../../Impressum.html">Impressum</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="/wiki">Wiki</a></li><li class="last"><a href="/screenshots">Bildschirmfotos</a></li>
    </ul>
  </div>
    <div id="langmenu"><ul><li class="first"><span title="Select a language of wiki content">Language:</span></li><li class=" active"><a class="" href="repack_fw.html" title="displaying language (default)">German</a></li><li class=" last"><a class=" notexist" href="/wiki/help/howtos/development/repack_fw.en" title="(not available)">English</a></li></ul></div><p /><div id="main">
      <div id="pagepath" class="noprint">
  <a class="pathentry first" title="Zeige WikiStart an" href="/wiki">Wiki:</a><a class="pathentry" href="../../../help.html" title="Zeige help an">help</a><span class="pathentry sep">/</span><a class="pathentry" href="../../howtos.html" title="Zeige help/howtos an">howtos</a><span class="pathentry sep">/</span><a class="pathentry" href="../development.html" title="Zeige help/howtos/development an">development</a><span class="pathentry sep">/</span><a class="pathentry" href="repack_fw.html" title="Zeige help/howtos/development/repack_fw an">repack_fw</a>
</div>
    <div id="content" class="wiki">
      <div class="wikipage searchable">

          <div id="wikipage" class="trac-content"><p>
</p><div class="wiki-toc"><h4>Inhaltsverzeichnis</h4><ol><li><a href="repack_fw.html#ToolsundSyntax">Tools und Syntax</a></li><li><a href="repack_fw.html#Vorgehensweise">Vorgehensweise</a></li><li><a href="repack_fw.html#Verwendungvonfwmodimnofreetz-Modus">Verwendung von fwmod im "no freetz"-Modus</a></li></ol></div><p>
</p>
<h1 id="EntpackenundPackenvonFirmware-Images">Entpacken und Packen von Firmware-Images</h1>
<p>
Wenn man ein Firmware-Image entpacken, ändern und wieder packen möchte, geht das wie folgt (nach Anleitung von <a class="ext-link" href="http://www.ip-phone-forum.de/member.php?u=117253"><span class="icon">​</span>Alexander Kriegisch</a> - in <a class="ext-link" href="http://www.ip-phone-forum.de/showthread.php?t=175974"><span class="icon">​</span>diesem Forums-Thread</a>:
</p>
<h2 id="ToolsundSyntax">Tools und Syntax</h2>
<p>
Am einfachsten ist es, Freetz als Infrastruktur zu benutzen, und zwar das Skript <tt>fwmod</tt> aus dem Freetz-Hauptverzeichnis.
Wenn man es ohne Parameter aufruft, verrät es wie es benutzt werden möchte:
</p>
<pre class="wiki">$ ./fwmod

Usage: fwmod [-u|-m|-p|-a] [-i &lt;cfg&gt;] [-d &lt;dir&gt;] &lt;orig_fw&gt; [&lt;tk_fw&gt; [&lt;aux_fw&gt;]]
  actions
    -u         unpack firmware image
    -m         modify previously unpacked image
    -p         pack firmware image
    -a         all: unpack, modify and pack firmware image (-u -m -p, default)
  special actions
    -n         firmware-nocompile: do not install kernel and busybox
    -f         force pack even if image is too big for flash (AVM SDK)
    -z         zip file system into archive for USB/NFS root
    -c &lt;dir&gt;   copy file system to target directory for NFS/USB root (implies -z)
  input/output
    -i &lt;cfg&gt;   input file for configuration data (default: .config)
    -d &lt;dir&gt;   build directory (default: &lt;orig_firmware&gt;.mod)
    &lt;orig_fw&gt;  original firmware name
    &lt;tk_fw&gt;    2nd firmware name (e.g. for merging in web UI)
    &lt;aux_fw&gt;   3rd firmware name (e.g. to borrow missing files)
</pre><p>
Man braucht also einmal den Aufruf mit <tt>-u</tt> zum Entpacken, dann nach der Modifikation den mit <tt>-p</tt> zum erneuten Packen.
</p>
<h2 id="Vorgehensweise">Vorgehensweise</h2>
<p>
Im Folgenden wird davon ausgegangen, dass sich der Benutzer im Hauptverzeichnis des frisch ausgepackten oder ausgecheckten Freetz befindet und das zu modifizierende Firmware-Image bereits in dieses Verzeichnis heruntergeladen hat. Dann sind folgende Schritte auszuführen:
</p>
<ol><li>Zunächst muss man eine passende Konfigurationsdatei <em>.config</em> erzeugen, damit beim Packen später das Skript <em>fwmod</em> die erforderlichen Informationen findet. Dazu ruft man einmal <em>make menuconfig</em> auf, wählt die richtige Hardware (z.B. 7170) aus und verlässt die Konfiguration, wobei man die Frage nach dem Abspeichern bejaht.
</li><li>Bevor man <em>fwmod</em> erstmals aufrufen kann, müssen einige Werkzeuge gebaut werden, die später indirekt aufgerufen werden, um die Firmware zu entpacken und später wieder zusammenzubauen: <em>make tools</em>. Das kann ein Weilchen (einige Minuten) dauern. Internet-Downloads via <em>wget</em> müssen dazu funktionieren.
</li><li>Jetzt entpackt man das von AVM heruntergeladene Firmware-Image in ein Verzeichnis, das hier beispielhaft <em>unpacked_firmware</em> genannt wird:
<pre class="wiki">./fwmod -u -d unpacked_firmware FRITZ.Box_Fon_WLAN_7170.29.04.59.image
</pre></li><li>Unter <em>unpacked_firmware/original/filesystem</em> modifiziert man dann das Dateisystem der Firmware.
</li><li>Zum guten Schluss packt man dann wieder das Firmware-Image:<br />
<pre class="wiki">./fwmod -p -d unpacked_firmware FRITZ.Box_Fon_WLAN_7170.29.04.59.image
</pre></li></ol><p>
Das ist also der gleiche Aufruf wie vorher, nur mit <tt>-p</tt> statt <tt>-u</tt>. Den Namen des Original-Images muss man leider mit angeben, obwohl das Image zum Packen nicht benötigt wird. Das ist eine kleine Schwäche des Skripts <tt>fwmod</tt>.
</p>
<ol start="6"><li>Nach einer Weile steht am Ende der Skript-Ausgabe so etwas wie
<pre class="wiki">creating filesystem image
merging kernel image
 kernel image size: 6969088 (max: 7798784, free: 829696)
packing 7170_.de_20080923-200251.image
done.

FINISHED
</pre></li></ol><p>
<strong>Anmerkungen zu den Freetz-Versionen bis einschließlich 1.1:
</strong></p>
<ul><li>Bei diesen Versionen muss den beiden <tt>fwmod</tt>-Aufrufen folgender fakeroot-Teil vorangestellt werden <tt>tools/build/bin/fakeroot -- </tt> (fwmod hat es erwartet in fakeroot-Umgebung aufgerufen zu werden und hat sich selbst um diese noch nicht gekümmert)
</li><li>Bei Fehlermeldung <tt>fakeroot: preload library `libfakeroot.so' not found, aborting.</tt> hilft ein vorangestelltes LD_PATH_PRELOAD:
<pre class="wiki">LD_PATH_PRELOAD=tools/build/lib/libfakeroot.so tools/build/bin/fakeroot -- ./fwmod ...
</pre></li></ul><h2 id="Verwendungvonfwmodimnofreetz-Modus">Verwendung von fwmod im "no freetz"-Modus</h2>
<p>
Seit trunk-<a class="changeset" href="/changeset/13796" title="fwmod:
 * be a little bit more friendly to the users of the Freetz ...">r13796</a> ist es möglich fwmod im quasi "no freetz"-Modus zu verwenden. Vom Ablauf her entspricht dieser Modus dem Bauen einer freetz-modifizierten Firmware. In diesem Modus wird jedoch keine einzige freetz-Änderung vorgenommen. Stattdessen wird ein Hook aufgerufen, in dem man eigene Modifikationen der Firmware implementieren und automatisiert ausführen lassen kann. Konkret gehe man wie folgt vor:
</p>
<ol><li>Man rufe <tt>make menuconfig</tt> auf, schalte den Experten-Modus ein ("Level of User Competence" = Expert), wähle die richtige Hardware (z.B. 7390) aus und aktiviere anschließend unter "Firmware packaging (fwmod) options" die Option "Skip modifying unpacked firmware, adding Freetz stuff". Der letzte Schritt entspricht dem Aktivieren des "no freetz"-Modus. Seit Fritz!OS-6.5x empfiehlt es sich weiterhin die Option "Sign image" (ebenfalls unter "Firmware packaging (fwmod) options" zu finden) zu aktivieren (s. dazu den <a class="ext-link" href="http://trac.freetz.org/wiki/help/howtos/development/sign_image"><span class="icon">​</span>Signieren von Firmware</a>-Artikel).
</li><li>Die eigenen Mods der Firmware sind in dem Script <a class="ext-link" href="http://trac.freetz.org/browser/trunk/fwmod_custom"><span class="icon">​</span>fwmod_custom</a> in der Funktion <a class="ext-link" href="http://trac.freetz.org/browser/trunk/fwmod_custom?rev=13796#L14"><span class="icon">​</span>all_no_freetz</a> zu implementieren. Das entpackte Root-Dateisystem steht dabei unter <tt>./filesystem</tt> zur Verfügung. fwmod_custom enthält bereits einige auskommentierte Beispiele: <a class="ext-link" href="http://trac.freetz.org/browser/trunk/fwmod_custom?rev=13796#L17"><span class="icon">​</span>restore telnet support</a>, <a class="ext-link" href="http://trac.freetz.org/browser/trunk/fwmod_custom?rev=13796#L25"><span class="icon">​</span>restore debug.cfg support</a>.
</li><li>Anschließend rufe man <tt>make</tt> auf. Das entpackte, fwmod_custom-modifizierte, wieder zusammengepackte und ggf. signierte Image ist unter <tt>images/</tt> zu finden.
<pre class="wiki">STEP 1: UNPACK
unpacking firmware image
removing NMI vector from SquashFS
NMI vector v1 found at offset 0xBE0000, removing it ... done.
splitting kernel image
unpacking filesystem image
    Reading a different endian SQUASHFS filesystem on build/original/kernel/kernelsquashfs.raw
    Filesystem on build/original/kernel/kernelsquashfs.raw is lzma compressed (3:76)
    Parallel unsquashfs: Using 1 processor
    6112 inodes (6522 blocks) to write
    created 5328 files
    created 373 directories
    created 697 symlinks
    created 87 devices
    created 0 fifos
unpacking AVM plugins
    tam image
    webcm_interpreter image
    wlan image
unpacking var.tar
done.

detected firmware 7390_de 84.06.80 rev43122 (07.02.2017 12:23:41)

STEP 3: PACK/SIGN
WARNING: Modifications (STEP 2) and this step should never
         ever be run with different configurations!
         This can result in invalid images!!!
WARNING: firmware does not seem to be modified by the script
invoking custom script
  restoring support for /var/flash/debug.cfg
    patching ./filesystem/etc/init.d/rc.tail.sh
  checking for left over Subversion directories
packing var.tar
Image signing files found, checking their consistency
Copying /home/gene/.freetz.image_signing.asc to /etc/avm_firmware_public_key9
creating filesystem image
  SquashFS block size: 64 kB (65536 bytes)
merging kernel image
  kernel image size: 14.6 MB, max 14.9 MB, free 0.3 MB (269568 bytes)
  WARNING: Not enough free flash space for answering machine!
adding checksum to kernel.image
packing images/7390_06.80.de_20170220-222457.image
  image file size: 16.8 MB
signing images/7390_06.80.de_20170220-222457.image
  signed image file size: 16.8 MB
done.

FINISHED
</pre></li></ol></div>

      </div><ul class="tags"><li class="header">Tags</li><li><a href="/tags/firmware" rel="tag">firmware</a> </li><li><a href="/tags/howtos" rel="tag">howtos</a> </li></ul>

    </div>
    </div>
  </body>
</html>
